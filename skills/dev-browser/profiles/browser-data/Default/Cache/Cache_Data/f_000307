import { supabase } from "/src/lib/supabase.ts";
export function parseUtmParams(url) {
  const params = {};
  try {
    let searchParams;
    if (url.startsWith("http://") || url.startsWith("https://")) {
      const urlObj = new URL(url);
      searchParams = urlObj.searchParams;
    } else if (url.startsWith("?")) {
      searchParams = new URLSearchParams(url);
    } else {
      searchParams = new URLSearchParams("?" + url);
    }
    const utm_source = searchParams.get("utm_source");
    const utm_medium = searchParams.get("utm_medium");
    const utm_campaign = searchParams.get("utm_campaign");
    const utm_term = searchParams.get("utm_term");
    const utm_content = searchParams.get("utm_content");
    if (utm_source) params.utm_source = utm_source;
    if (utm_medium) params.utm_medium = utm_medium;
    if (utm_campaign) params.utm_campaign = utm_campaign;
    if (utm_term) params.utm_term = utm_term;
    if (utm_content) params.utm_content = utm_content;
  } catch (error) {
    console.error("Error parsing UTM params:", error);
  }
  return params;
}
export function inferSourceMedium(utmParams, referrer) {
  if (utmParams?.utm_source) {
    return {
      source: utmParams.utm_source,
      medium: utmParams.utm_medium || "unknown"
    };
  }
  if (referrer) {
    try {
      const referrerUrl = new URL(referrer);
      const hostname = referrerUrl.hostname.toLowerCase();
      if (hostname.includes("google")) {
        return { source: "google", medium: "organic" };
      }
      if (hostname.includes("facebook") || hostname.includes("fb.")) {
        return { source: "facebook", medium: "social" };
      }
      if (hostname.includes("instagram")) {
        return { source: "instagram", medium: "social" };
      }
      if (hostname.includes("linkedin")) {
        return { source: "linkedin", medium: "social" };
      }
      if (hostname.includes("twitter") || hostname.includes("t.co")) {
        return { source: "twitter", medium: "social" };
      }
      if (hostname.includes("youtube")) {
        return { source: "youtube", medium: "video" };
      }
      if (hostname.includes("bing")) {
        return { source: "bing", medium: "organic" };
      }
      return { source: hostname, medium: "referral" };
    } catch {
    }
  }
  return { source: "direct", medium: "none" };
}
export async function trackAttribution(data) {
  const { error, data: result } = await supabase.from("lead_attributions").insert([data]).select().single();
  if (error) {
    console.error("Error tracking attribution:", error);
    throw error;
  }
  return result;
}
export async function getAttributionReport(daysBack = 30) {
  const startDate = /* @__PURE__ */ new Date();
  startDate.setDate(startDate.getDate() - daysBack);
  const { data: contacts, error } = await supabase.from("ghl_contacts").select("id, source, first_attribution_source, first_attribution_medium, first_attribution_url, tags").gte("ghl_date_added", startDate.toISOString());
  if (error) {
    console.error("Error fetching GHL contacts for attribution:", error);
    throw error;
  }
  const statsMap = /* @__PURE__ */ new Map();
  contacts?.forEach((contact) => {
    const source = contact.first_attribution_source || contact.source || "Unknown";
    const medium = contact.first_attribution_medium || "Unknown";
    const key = `${source}|${medium}`;
    if (!statsMap.has(key)) {
      statsMap.set(key, { leads: 0, conversions: 0 });
    }
    const stat = statsMap.get(key);
    stat.leads++;
    const tags = contact.tags || [];
    const hasConversion = tags.some(
      (tag) => tag.toLowerCase().includes("funded") || tag.toLowerCase().includes("won") || tag.toLowerCase().includes("closed")
    );
    if (hasConversion) {
      stat.conversions++;
    }
  });
  const result = Array.from(statsMap.entries()).map(([key, stat]) => {
    const [source, medium] = key.split("|");
    return {
      source,
      medium,
      campaign: "",
      lead_count: stat.leads,
      conversion_count: stat.conversions,
      conversion_rate: stat.leads > 0 ? stat.conversions / stat.leads * 100 : 0
    };
  }).sort((a, b) => b.lead_count - a.lead_count);
  return result;
}
export async function getFunnels(activeOnly = true) {
  let query = supabase.from("funnels").select("*").order("created_at", { ascending: false });
  if (activeOnly) {
    query = query.eq("is_active", true);
  }
  const { data, error } = await query;
  if (error) {
    console.error("Error fetching funnels:", error);
    throw error;
  }
  return data || [];
}
export async function getFunnelBySlug(slug) {
  const { data, error } = await supabase.from("funnels").select("*").eq("slug", slug).single();
  if (error) {
    if (error.code === "PGRST116") {
      return null;
    }
    console.error("Error fetching funnel:", error);
    throw error;
  }
  return data;
}
export async function createFunnel(funnel) {
  const { data, error } = await supabase.from("funnels").insert([funnel]).select().single();
  if (error) {
    console.error("Error creating funnel:", error);
    throw error;
  }
  return data;
}
export async function updateFunnel(id, updates) {
  const { data, error } = await supabase.from("funnels").update({ ...updates, updated_at: (/* @__PURE__ */ new Date()).toISOString() }).eq("id", id).select().single();
  if (error) {
    console.error("Error updating funnel:", error);
    throw error;
  }
  return data;
}
export async function deleteFunnel(id) {
  const { error } = await supabase.from("funnels").delete().eq("id", id);
  if (error) {
    console.error("Error deleting funnel:", error);
    throw error;
  }
}
export async function getFunnelStats(funnelSlug, daysBack = 30) {
  const { data, error } = await supabase.rpc("get_funnel_stats", {
    funnel_slug_param: funnelSlug,
    days_back: daysBack
  });
  if (error) {
    console.error("Error fetching funnel stats:", error);
    throw error;
  }
  return data || [];
}
export async function trackFunnelConversion(conversion) {
  const { data, error } = await supabase.from("funnel_conversions").insert([conversion]).select().single();
  if (error) {
    console.error("Error tracking funnel conversion:", error);
    throw error;
  }
  return data;
}
export async function getContactConversions(contactId, funnelId) {
  let query = supabase.from("funnel_conversions").select("*").eq("contact_id", contactId).order("converted_at", { ascending: true });
  if (funnelId) {
    query = query.eq("funnel_id", funnelId);
  }
  const { data, error } = await query;
  if (error) {
    console.error("Error fetching contact conversions:", error);
    throw error;
  }
  return data || [];
}
export async function getUtmAnalysis(daysBack = 30) {
  const startDate = /* @__PURE__ */ new Date();
  startDate.setDate(startDate.getDate() - daysBack);
  const { data: contacts, error } = await supabase.from("ghl_contacts").select("source, first_attribution_source, first_attribution_medium, first_attribution_url").gte("ghl_date_added", startDate.toISOString());
  if (error) {
    console.error("Error fetching UTM analysis:", error);
    throw error;
  }
  const sourceMap = /* @__PURE__ */ new Map();
  const mediumMap = /* @__PURE__ */ new Map();
  const campaignMap = /* @__PURE__ */ new Map();
  const leadSourceMap = /* @__PURE__ */ new Map();
  contacts?.forEach((contact) => {
    if (contact.first_attribution_source) {
      sourceMap.set(contact.first_attribution_source, (sourceMap.get(contact.first_attribution_source) || 0) + 1);
    }
    if (contact.first_attribution_medium) {
      mediumMap.set(contact.first_attribution_medium, (mediumMap.get(contact.first_attribution_medium) || 0) + 1);
    }
    if (contact.source) {
      leadSourceMap.set(contact.source, (leadSourceMap.get(contact.source) || 0) + 1);
    }
    if (contact.first_attribution_url) {
      const utmParams = parseUtmParams(contact.first_attribution_url);
      if (utmParams.utm_campaign) {
        campaignMap.set(utmParams.utm_campaign, (campaignMap.get(utmParams.utm_campaign) || 0) + 1);
      }
    }
  });
  const sources = Array.from(sourceMap.entries()).map(([value, count]) => ({ value, count })).sort((a, b) => b.count - a.count);
  const mediums = Array.from(mediumMap.entries()).map(([value, count]) => ({ value, count })).sort((a, b) => b.count - a.count);
  const campaigns = Array.from(campaignMap.entries()).map(([value, count]) => ({ value, count })).sort((a, b) => b.count - a.count);
  const leadSources = Array.from(leadSourceMap.entries()).map(([value, count]) => ({ value, count })).sort((a, b) => b.count - a.count);
  return { sources, mediums, campaigns, leadSources };
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF0dHJpYnV0aW9uLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBBdHRyaWJ1dGlvbiBTZXJ2aWNlXHJcbiAqIEhhbmRsZXMgbGVhZCBhdHRyaWJ1dGlvbiB0cmFja2luZywgVVRNIHBhcmFtZXRlciBwYXJzaW5nLCBhbmQgZnVubmVsIGFuYWx5dGljc1xyXG4gKi9cclxuXHJcbmltcG9ydCB7IHN1cGFiYXNlIH0gZnJvbSAnLi4vbGliL3N1cGFiYXNlJztcclxuXHJcbi8vIFR5cGVzXHJcbmV4cG9ydCBpbnRlcmZhY2UgVXRtUGFyYW1zIHtcclxuICB1dG1fc291cmNlPzogc3RyaW5nO1xyXG4gIHV0bV9tZWRpdW0/OiBzdHJpbmc7XHJcbiAgdXRtX2NhbXBhaWduPzogc3RyaW5nO1xyXG4gIHV0bV90ZXJtPzogc3RyaW5nO1xyXG4gIHV0bV9jb250ZW50Pzogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEF0dHJpYnV0aW9uRGF0YSB7XHJcbiAgY29udGFjdF9pZDogc3RyaW5nO1xyXG4gIHNvdXJjZT86IHN0cmluZztcclxuICBtZWRpdW0/OiBzdHJpbmc7XHJcbiAgY2FtcGFpZ24/OiBzdHJpbmc7XHJcbiAgdXRtX3BhcmFtcz86IFV0bVBhcmFtcztcclxuICBsYW5kaW5nX3BhZ2U/OiBzdHJpbmc7XHJcbiAgcmVmZXJyZXI/OiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQXR0cmlidXRpb25TdGF0cyB7XHJcbiAgc291cmNlOiBzdHJpbmc7XHJcbiAgbWVkaXVtOiBzdHJpbmc7XHJcbiAgY2FtcGFpZ246IHN0cmluZztcclxuICBsZWFkX2NvdW50OiBudW1iZXI7XHJcbiAgY29udmVyc2lvbl9jb3VudDogbnVtYmVyO1xyXG4gIGNvbnZlcnNpb25fcmF0ZTogbnVtYmVyO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEZ1bm5lbFN0YXRzIHtcclxuICBzdGFnZV9uYW1lOiBzdHJpbmc7XHJcbiAgc3RhZ2Vfb3JkZXI6IG51bWJlcjtcclxuICBjb252ZXJzaW9uX2NvdW50OiBudW1iZXI7XHJcbiAgZHJvcF9vZmZfY291bnQ6IG51bWJlcjtcclxuICBjb252ZXJzaW9uX3JhdGU6IG51bWJlcjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBGdW5uZWwge1xyXG4gIGlkOiBzdHJpbmc7XHJcbiAgbmFtZTogc3RyaW5nO1xyXG4gIHNsdWc6IHN0cmluZztcclxuICBkZXNjcmlwdGlvbjogc3RyaW5nO1xyXG4gIHN0YWdlczogRnVubmVsU3RhZ2VbXTtcclxuICBpc19hY3RpdmU6IGJvb2xlYW47XHJcbiAgY3JlYXRlZF9hdDogc3RyaW5nO1xyXG4gIHVwZGF0ZWRfYXQ6IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBGdW5uZWxTdGFnZSB7XHJcbiAgbmFtZTogc3RyaW5nO1xyXG4gIG9yZGVyOiBudW1iZXI7XHJcbiAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRnVubmVsQ29udmVyc2lvbiB7XHJcbiAgaWQ6IHN0cmluZztcclxuICBmdW5uZWxfaWQ6IHN0cmluZztcclxuICBjb250YWN0X2lkOiBzdHJpbmc7XHJcbiAgc3RhZ2U6IHN0cmluZztcclxuICBzdGFnZV9vcmRlcjogbnVtYmVyO1xyXG4gIGNvbnZlcnRlZF9hdDogc3RyaW5nO1xyXG4gIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgYW55PjtcclxufVxyXG5cclxuLyoqXHJcbiAqIFBhcnNlIFVUTSBwYXJhbWV0ZXJzIGZyb20gYSBVUkxcclxuICogQHBhcmFtIHVybCAtIEZ1bGwgVVJMIG9yIHF1ZXJ5IHN0cmluZ1xyXG4gKiBAcmV0dXJucyBQYXJzZWQgVVRNIHBhcmFtZXRlcnNcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBwYXJzZVV0bVBhcmFtcyh1cmw6IHN0cmluZyk6IFV0bVBhcmFtcyB7XHJcbiAgY29uc3QgcGFyYW1zOiBVdG1QYXJhbXMgPSB7fTtcclxuXHJcbiAgdHJ5IHtcclxuICAgIC8vIEhhbmRsZSBib3RoIGZ1bGwgVVJMcyBhbmQgcXVlcnkgc3RyaW5nc1xyXG4gICAgbGV0IHNlYXJjaFBhcmFtczogVVJMU2VhcmNoUGFyYW1zO1xyXG5cclxuICAgIGlmICh1cmwuc3RhcnRzV2l0aCgnaHR0cDovLycpIHx8IHVybC5zdGFydHNXaXRoKCdodHRwczovLycpKSB7XHJcbiAgICAgIGNvbnN0IHVybE9iaiA9IG5ldyBVUkwodXJsKTtcclxuICAgICAgc2VhcmNoUGFyYW1zID0gdXJsT2JqLnNlYXJjaFBhcmFtcztcclxuICAgIH0gZWxzZSBpZiAodXJsLnN0YXJ0c1dpdGgoJz8nKSkge1xyXG4gICAgICBzZWFyY2hQYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHVybCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBzZWFyY2hQYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKCc/JyArIHVybCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRXh0cmFjdCBVVE0gcGFyYW1ldGVyc1xyXG4gICAgY29uc3QgdXRtX3NvdXJjZSA9IHNlYXJjaFBhcmFtcy5nZXQoJ3V0bV9zb3VyY2UnKTtcclxuICAgIGNvbnN0IHV0bV9tZWRpdW0gPSBzZWFyY2hQYXJhbXMuZ2V0KCd1dG1fbWVkaXVtJyk7XHJcbiAgICBjb25zdCB1dG1fY2FtcGFpZ24gPSBzZWFyY2hQYXJhbXMuZ2V0KCd1dG1fY2FtcGFpZ24nKTtcclxuICAgIGNvbnN0IHV0bV90ZXJtID0gc2VhcmNoUGFyYW1zLmdldCgndXRtX3Rlcm0nKTtcclxuICAgIGNvbnN0IHV0bV9jb250ZW50ID0gc2VhcmNoUGFyYW1zLmdldCgndXRtX2NvbnRlbnQnKTtcclxuXHJcbiAgICBpZiAodXRtX3NvdXJjZSkgcGFyYW1zLnV0bV9zb3VyY2UgPSB1dG1fc291cmNlO1xyXG4gICAgaWYgKHV0bV9tZWRpdW0pIHBhcmFtcy51dG1fbWVkaXVtID0gdXRtX21lZGl1bTtcclxuICAgIGlmICh1dG1fY2FtcGFpZ24pIHBhcmFtcy51dG1fY2FtcGFpZ24gPSB1dG1fY2FtcGFpZ247XHJcbiAgICBpZiAodXRtX3Rlcm0pIHBhcmFtcy51dG1fdGVybSA9IHV0bV90ZXJtO1xyXG4gICAgaWYgKHV0bV9jb250ZW50KSBwYXJhbXMudXRtX2NvbnRlbnQgPSB1dG1fY29udGVudDtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgcGFyc2luZyBVVE0gcGFyYW1zOicsIGVycm9yKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBwYXJhbXM7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBJbmZlciBzb3VyY2UgYW5kIG1lZGl1bSBmcm9tIFVUTSBwYXJhbXMgb3IgcmVmZXJyZXJcclxuICogQHBhcmFtIHV0bVBhcmFtcyAtIFBhcnNlZCBVVE0gcGFyYW1ldGVyc1xyXG4gKiBAcGFyYW0gcmVmZXJyZXIgLSBIVFRQIHJlZmVycmVyXHJcbiAqIEByZXR1cm5zIEluZmVycmVkIHNvdXJjZSBhbmQgbWVkaXVtXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gaW5mZXJTb3VyY2VNZWRpdW0odXRtUGFyYW1zPzogVXRtUGFyYW1zLCByZWZlcnJlcj86IHN0cmluZyk6IHtcclxuICBzb3VyY2U6IHN0cmluZyB8IHVuZGVmaW5lZDtcclxuICBtZWRpdW06IHN0cmluZyB8IHVuZGVmaW5lZDtcclxufSB7XHJcbiAgLy8gSWYgVVRNIHBhcmFtcyBleGlzdCwgdXNlIHRoZW1cclxuICBpZiAodXRtUGFyYW1zPy51dG1fc291cmNlKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzb3VyY2U6IHV0bVBhcmFtcy51dG1fc291cmNlLFxyXG4gICAgICBtZWRpdW06IHV0bVBhcmFtcy51dG1fbWVkaXVtIHx8ICd1bmtub3duJyxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvLyBJbmZlciBmcm9tIHJlZmVycmVyXHJcbiAgaWYgKHJlZmVycmVyKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCByZWZlcnJlclVybCA9IG5ldyBVUkwocmVmZXJyZXIpO1xyXG4gICAgICBjb25zdCBob3N0bmFtZSA9IHJlZmVycmVyVXJsLmhvc3RuYW1lLnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgICAvLyBDb21tb24gc291cmNlc1xyXG4gICAgICBpZiAoaG9zdG5hbWUuaW5jbHVkZXMoJ2dvb2dsZScpKSB7XHJcbiAgICAgICAgcmV0dXJuIHsgc291cmNlOiAnZ29vZ2xlJywgbWVkaXVtOiAnb3JnYW5pYycgfTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoaG9zdG5hbWUuaW5jbHVkZXMoJ2ZhY2Vib29rJykgfHwgaG9zdG5hbWUuaW5jbHVkZXMoJ2ZiLicpKSB7XHJcbiAgICAgICAgcmV0dXJuIHsgc291cmNlOiAnZmFjZWJvb2snLCBtZWRpdW06ICdzb2NpYWwnIH07XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGhvc3RuYW1lLmluY2x1ZGVzKCdpbnN0YWdyYW0nKSkge1xyXG4gICAgICAgIHJldHVybiB7IHNvdXJjZTogJ2luc3RhZ3JhbScsIG1lZGl1bTogJ3NvY2lhbCcgfTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoaG9zdG5hbWUuaW5jbHVkZXMoJ2xpbmtlZGluJykpIHtcclxuICAgICAgICByZXR1cm4geyBzb3VyY2U6ICdsaW5rZWRpbicsIG1lZGl1bTogJ3NvY2lhbCcgfTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoaG9zdG5hbWUuaW5jbHVkZXMoJ3R3aXR0ZXInKSB8fCBob3N0bmFtZS5pbmNsdWRlcygndC5jbycpKSB7XHJcbiAgICAgICAgcmV0dXJuIHsgc291cmNlOiAndHdpdHRlcicsIG1lZGl1bTogJ3NvY2lhbCcgfTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoaG9zdG5hbWUuaW5jbHVkZXMoJ3lvdXR1YmUnKSkge1xyXG4gICAgICAgIHJldHVybiB7IHNvdXJjZTogJ3lvdXR1YmUnLCBtZWRpdW06ICd2aWRlbycgfTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoaG9zdG5hbWUuaW5jbHVkZXMoJ2JpbmcnKSkge1xyXG4gICAgICAgIHJldHVybiB7IHNvdXJjZTogJ2JpbmcnLCBtZWRpdW06ICdvcmdhbmljJyB9O1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBHZW5lcmljIHJlZmVycmFsXHJcbiAgICAgIHJldHVybiB7IHNvdXJjZTogaG9zdG5hbWUsIG1lZGl1bTogJ3JlZmVycmFsJyB9O1xyXG4gICAgfSBjYXRjaCB7XHJcbiAgICAgIC8vIEludmFsaWQgcmVmZXJyZXIgVVJMXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBEaXJlY3QgdHJhZmZpY1xyXG4gIHJldHVybiB7IHNvdXJjZTogJ2RpcmVjdCcsIG1lZGl1bTogJ25vbmUnIH07XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBUcmFjayBhdHRyaWJ1dGlvbiBmb3IgYSBjb250YWN0XHJcbiAqIEBwYXJhbSBkYXRhIC0gQXR0cmlidXRpb24gZGF0YVxyXG4gKiBAcmV0dXJucyBDcmVhdGVkIGF0dHJpYnV0aW9uIHJlY29yZFxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHRyYWNrQXR0cmlidXRpb24oZGF0YTogQXR0cmlidXRpb25EYXRhKSB7XHJcbiAgY29uc3QgeyBlcnJvciwgZGF0YTogcmVzdWx0IH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgLmZyb20oJ2xlYWRfYXR0cmlidXRpb25zJylcclxuICAgIC5pbnNlcnQoW2RhdGFdKVxyXG4gICAgLnNlbGVjdCgpXHJcbiAgICAuc2luZ2xlKCk7XHJcblxyXG4gIGlmIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgdHJhY2tpbmcgYXR0cmlidXRpb246JywgZXJyb3IpO1xyXG4gICAgdGhyb3cgZXJyb3I7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gcmVzdWx0O1xyXG59XHJcblxyXG4vKipcclxuICogR2V0IGF0dHJpYnV0aW9uIHJlcG9ydCBmcm9tIEdITCBjb250YWN0cyAoc291cmNlL21lZGl1bSBicmVha2Rvd24pXHJcbiAqIEBwYXJhbSBkYXlzQmFjayAtIE51bWJlciBvZiBkYXlzIHRvIGxvb2sgYmFjayAoZGVmYXVsdCAzMClcclxuICogQHJldHVybnMgQXR0cmlidXRpb24gc3RhdGlzdGljc1xyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEF0dHJpYnV0aW9uUmVwb3J0KGRheXNCYWNrOiBudW1iZXIgPSAzMCk6IFByb21pc2U8QXR0cmlidXRpb25TdGF0c1tdPiB7XHJcbiAgY29uc3Qgc3RhcnREYXRlID0gbmV3IERhdGUoKTtcclxuICBzdGFydERhdGUuc2V0RGF0ZShzdGFydERhdGUuZ2V0RGF0ZSgpIC0gZGF5c0JhY2spO1xyXG5cclxuICAvLyBGZXRjaCBHSEwgY29udGFjdHMgd2l0aCBhdHRyaWJ1dGlvbiBkYXRhXHJcbiAgY29uc3QgeyBkYXRhOiBjb250YWN0cywgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAuZnJvbSgnZ2hsX2NvbnRhY3RzJylcclxuICAgIC5zZWxlY3QoJ2lkLCBzb3VyY2UsIGZpcnN0X2F0dHJpYnV0aW9uX3NvdXJjZSwgZmlyc3RfYXR0cmlidXRpb25fbWVkaXVtLCBmaXJzdF9hdHRyaWJ1dGlvbl91cmwsIHRhZ3MnKVxyXG4gICAgLmd0ZSgnZ2hsX2RhdGVfYWRkZWQnLCBzdGFydERhdGUudG9JU09TdHJpbmcoKSk7XHJcblxyXG4gIGlmIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZmV0Y2hpbmcgR0hMIGNvbnRhY3RzIGZvciBhdHRyaWJ1dGlvbjonLCBlcnJvcik7XHJcbiAgICB0aHJvdyBlcnJvcjtcclxuICB9XHJcblxyXG4gIC8vIEFnZ3JlZ2F0ZSBieSBzb3VyY2UvbWVkaXVtXHJcbiAgY29uc3Qgc3RhdHNNYXAgPSBuZXcgTWFwPHN0cmluZywgeyBsZWFkczogbnVtYmVyOyBjb252ZXJzaW9uczogbnVtYmVyIH0+KCk7XHJcblxyXG4gIGNvbnRhY3RzPy5mb3JFYWNoKChjb250YWN0KSA9PiB7XHJcbiAgICBjb25zdCBzb3VyY2UgPSBjb250YWN0LmZpcnN0X2F0dHJpYnV0aW9uX3NvdXJjZSB8fCBjb250YWN0LnNvdXJjZSB8fCAnVW5rbm93bic7XHJcbiAgICBjb25zdCBtZWRpdW0gPSBjb250YWN0LmZpcnN0X2F0dHJpYnV0aW9uX21lZGl1bSB8fCAnVW5rbm93bic7XHJcbiAgICBjb25zdCBrZXkgPSBgJHtzb3VyY2V9fCR7bWVkaXVtfWA7XHJcblxyXG4gICAgaWYgKCFzdGF0c01hcC5oYXMoa2V5KSkge1xyXG4gICAgICBzdGF0c01hcC5zZXQoa2V5LCB7IGxlYWRzOiAwLCBjb252ZXJzaW9uczogMCB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzdGF0ID0gc3RhdHNNYXAuZ2V0KGtleSkhO1xyXG4gICAgc3RhdC5sZWFkcysrO1xyXG5cclxuICAgIC8vIENoZWNrIGlmIGNvbnRhY3QgaGFzIGNvbnZlcnNpb24gdGFncyAoZnVuZGVkLCB3b24sIGV0Yy4pXHJcbiAgICBjb25zdCB0YWdzID0gY29udGFjdC50YWdzIHx8IFtdO1xyXG4gICAgY29uc3QgaGFzQ29udmVyc2lvbiA9IHRhZ3Muc29tZSgodGFnOiBzdHJpbmcpID0+XHJcbiAgICAgIHRhZy50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdmdW5kZWQnKSB8fFxyXG4gICAgICB0YWcudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnd29uJykgfHxcclxuICAgICAgdGFnLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ2Nsb3NlZCcpXHJcbiAgICApO1xyXG4gICAgaWYgKGhhc0NvbnZlcnNpb24pIHtcclxuICAgICAgc3RhdC5jb252ZXJzaW9ucysrO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICAvLyBDb252ZXJ0IHRvIGFycmF5IGZvcm1hdFxyXG4gIGNvbnN0IHJlc3VsdDogQXR0cmlidXRpb25TdGF0c1tdID0gQXJyYXkuZnJvbShzdGF0c01hcC5lbnRyaWVzKCkpXHJcbiAgICAubWFwKChba2V5LCBzdGF0XSkgPT4ge1xyXG4gICAgICBjb25zdCBbc291cmNlLCBtZWRpdW1dID0ga2V5LnNwbGl0KCd8Jyk7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgc291cmNlLFxyXG4gICAgICAgIG1lZGl1bSxcclxuICAgICAgICBjYW1wYWlnbjogJycsXHJcbiAgICAgICAgbGVhZF9jb3VudDogc3RhdC5sZWFkcyxcclxuICAgICAgICBjb252ZXJzaW9uX2NvdW50OiBzdGF0LmNvbnZlcnNpb25zLFxyXG4gICAgICAgIGNvbnZlcnNpb25fcmF0ZTogc3RhdC5sZWFkcyA+IDAgPyAoc3RhdC5jb252ZXJzaW9ucyAvIHN0YXQubGVhZHMpICogMTAwIDogMCxcclxuICAgICAgfTtcclxuICAgIH0pXHJcbiAgICAuc29ydCgoYSwgYikgPT4gYi5sZWFkX2NvdW50IC0gYS5sZWFkX2NvdW50KTtcclxuXHJcbiAgcmV0dXJuIHJlc3VsdDtcclxufVxyXG5cclxuLyoqXHJcbiAqIEdldCBhbGwgZnVubmVsc1xyXG4gKiBAcGFyYW0gYWN0aXZlT25seSAtIE9ubHkgcmV0dXJuIGFjdGl2ZSBmdW5uZWxzXHJcbiAqIEByZXR1cm5zIExpc3Qgb2YgZnVubmVsc1xyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEZ1bm5lbHMoYWN0aXZlT25seTogYm9vbGVhbiA9IHRydWUpOiBQcm9taXNlPEZ1bm5lbFtdPiB7XHJcbiAgbGV0IHF1ZXJ5ID0gc3VwYWJhc2UuZnJvbSgnZnVubmVscycpLnNlbGVjdCgnKicpLm9yZGVyKCdjcmVhdGVkX2F0JywgeyBhc2NlbmRpbmc6IGZhbHNlIH0pO1xyXG5cclxuICBpZiAoYWN0aXZlT25seSkge1xyXG4gICAgcXVlcnkgPSBxdWVyeS5lcSgnaXNfYWN0aXZlJywgdHJ1ZSk7XHJcbiAgfVxyXG5cclxuICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBxdWVyeTtcclxuXHJcbiAgaWYgKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBmZXRjaGluZyBmdW5uZWxzOicsIGVycm9yKTtcclxuICAgIHRocm93IGVycm9yO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGRhdGEgfHwgW107XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBHZXQgYSBzcGVjaWZpYyBmdW5uZWwgYnkgc2x1Z1xyXG4gKiBAcGFyYW0gc2x1ZyAtIEZ1bm5lbCBzbHVnXHJcbiAqIEByZXR1cm5zIEZ1bm5lbCBkYXRhXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0RnVubmVsQnlTbHVnKHNsdWc6IHN0cmluZyk6IFByb21pc2U8RnVubmVsIHwgbnVsbD4ge1xyXG4gIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlLmZyb20oJ2Z1bm5lbHMnKS5zZWxlY3QoJyonKS5lcSgnc2x1ZycsIHNsdWcpLnNpbmdsZSgpO1xyXG5cclxuICBpZiAoZXJyb3IpIHtcclxuICAgIGlmIChlcnJvci5jb2RlID09PSAnUEdSU1QxMTYnKSB7XHJcbiAgICAgIC8vIE5vdCBmb3VuZFxyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGZldGNoaW5nIGZ1bm5lbDonLCBlcnJvcik7XHJcbiAgICB0aHJvdyBlcnJvcjtcclxuICB9XHJcblxyXG4gIHJldHVybiBkYXRhO1xyXG59XHJcblxyXG4vKipcclxuICogQ3JlYXRlIGEgbmV3IGZ1bm5lbFxyXG4gKiBAcGFyYW0gZnVubmVsIC0gRnVubmVsIGRhdGEgKHdpdGhvdXQgaWQpXHJcbiAqIEByZXR1cm5zIENyZWF0ZWQgZnVubmVsXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlRnVubmVsKGZ1bm5lbDogT21pdDxGdW5uZWwsICdpZCcgfCAnY3JlYXRlZF9hdCcgfCAndXBkYXRlZF9hdCc+KTogUHJvbWlzZTxGdW5uZWw+IHtcclxuICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZS5mcm9tKCdmdW5uZWxzJykuaW5zZXJ0KFtmdW5uZWxdKS5zZWxlY3QoKS5zaW5nbGUoKTtcclxuXHJcbiAgaWYgKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBjcmVhdGluZyBmdW5uZWw6JywgZXJyb3IpO1xyXG4gICAgdGhyb3cgZXJyb3I7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gZGF0YTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFVwZGF0ZSBhIGZ1bm5lbFxyXG4gKiBAcGFyYW0gaWQgLSBGdW5uZWwgSURcclxuICogQHBhcmFtIHVwZGF0ZXMgLSBGaWVsZHMgdG8gdXBkYXRlXHJcbiAqIEByZXR1cm5zIFVwZGF0ZWQgZnVubmVsXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlRnVubmVsKGlkOiBzdHJpbmcsIHVwZGF0ZXM6IFBhcnRpYWw8RnVubmVsPik6IFByb21pc2U8RnVubmVsPiB7XHJcbiAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgIC5mcm9tKCdmdW5uZWxzJylcclxuICAgIC51cGRhdGUoeyAuLi51cGRhdGVzLCB1cGRhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgfSlcclxuICAgIC5lcSgnaWQnLCBpZClcclxuICAgIC5zZWxlY3QoKVxyXG4gICAgLnNpbmdsZSgpO1xyXG5cclxuICBpZiAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHVwZGF0aW5nIGZ1bm5lbDonLCBlcnJvcik7XHJcbiAgICB0aHJvdyBlcnJvcjtcclxuICB9XHJcblxyXG4gIHJldHVybiBkYXRhO1xyXG59XHJcblxyXG4vKipcclxuICogRGVsZXRlIGEgZnVubmVsXHJcbiAqIEBwYXJhbSBpZCAtIEZ1bm5lbCBJRFxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZUZ1bm5lbChpZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UuZnJvbSgnZnVubmVscycpLmRlbGV0ZSgpLmVxKCdpZCcsIGlkKTtcclxuXHJcbiAgaWYgKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBkZWxldGluZyBmdW5uZWw6JywgZXJyb3IpO1xyXG4gICAgdGhyb3cgZXJyb3I7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogR2V0IGZ1bm5lbCBzdGF0aXN0aWNzXHJcbiAqIEBwYXJhbSBmdW5uZWxTbHVnIC0gRnVubmVsIHNsdWdcclxuICogQHBhcmFtIGRheXNCYWNrIC0gTnVtYmVyIG9mIGRheXMgdG8gbG9vayBiYWNrIChkZWZhdWx0IDMwKVxyXG4gKiBAcmV0dXJucyBGdW5uZWwgY29udmVyc2lvbiBzdGF0aXN0aWNzIGJ5IHN0YWdlXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0RnVubmVsU3RhdHMoZnVubmVsU2x1Zzogc3RyaW5nLCBkYXlzQmFjazogbnVtYmVyID0gMzApOiBQcm9taXNlPEZ1bm5lbFN0YXRzW10+IHtcclxuICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZS5ycGMoJ2dldF9mdW5uZWxfc3RhdHMnLCB7XHJcbiAgICBmdW5uZWxfc2x1Z19wYXJhbTogZnVubmVsU2x1ZyxcclxuICAgIGRheXNfYmFjazogZGF5c0JhY2ssXHJcbiAgfSk7XHJcblxyXG4gIGlmIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZmV0Y2hpbmcgZnVubmVsIHN0YXRzOicsIGVycm9yKTtcclxuICAgIHRocm93IGVycm9yO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGRhdGEgfHwgW107XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBUcmFjayBhIGZ1bm5lbCBjb252ZXJzaW9uIChjb250YWN0IG1vdmVkIHRvIGEgc3RhZ2UpXHJcbiAqIEBwYXJhbSBjb252ZXJzaW9uIC0gQ29udmVyc2lvbiBkYXRhXHJcbiAqIEByZXR1cm5zIENyZWF0ZWQgY29udmVyc2lvbiByZWNvcmRcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB0cmFja0Z1bm5lbENvbnZlcnNpb24oXHJcbiAgY29udmVyc2lvbjogT21pdDxGdW5uZWxDb252ZXJzaW9uLCAnaWQnIHwgJ2NvbnZlcnRlZF9hdCc+XHJcbik6IFByb21pc2U8RnVubmVsQ29udmVyc2lvbj4ge1xyXG4gIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlLmZyb20oJ2Z1bm5lbF9jb252ZXJzaW9ucycpLmluc2VydChbY29udmVyc2lvbl0pLnNlbGVjdCgpLnNpbmdsZSgpO1xyXG5cclxuICBpZiAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHRyYWNraW5nIGZ1bm5lbCBjb252ZXJzaW9uOicsIGVycm9yKTtcclxuICAgIHRocm93IGVycm9yO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGRhdGE7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBHZXQgZnVubmVsIGNvbnZlcnNpb25zIGZvciBhIGNvbnRhY3RcclxuICogQHBhcmFtIGNvbnRhY3RJZCAtIEdITCBjb250YWN0IElEXHJcbiAqIEBwYXJhbSBmdW5uZWxJZCAtIE9wdGlvbmFsIGZ1bm5lbCBJRCBmaWx0ZXJcclxuICogQHJldHVybnMgTGlzdCBvZiBjb252ZXJzaW9uc1xyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldENvbnRhY3RDb252ZXJzaW9ucyhcclxuICBjb250YWN0SWQ6IHN0cmluZyxcclxuICBmdW5uZWxJZD86IHN0cmluZ1xyXG4pOiBQcm9taXNlPEZ1bm5lbENvbnZlcnNpb25bXT4ge1xyXG4gIGxldCBxdWVyeSA9IHN1cGFiYXNlXHJcbiAgICAuZnJvbSgnZnVubmVsX2NvbnZlcnNpb25zJylcclxuICAgIC5zZWxlY3QoJyonKVxyXG4gICAgLmVxKCdjb250YWN0X2lkJywgY29udGFjdElkKVxyXG4gICAgLm9yZGVyKCdjb252ZXJ0ZWRfYXQnLCB7IGFzY2VuZGluZzogdHJ1ZSB9KTtcclxuXHJcbiAgaWYgKGZ1bm5lbElkKSB7XHJcbiAgICBxdWVyeSA9IHF1ZXJ5LmVxKCdmdW5uZWxfaWQnLCBmdW5uZWxJZCk7XHJcbiAgfVxyXG5cclxuICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBxdWVyeTtcclxuXHJcbiAgaWYgKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBmZXRjaGluZyBjb250YWN0IGNvbnZlcnNpb25zOicsIGVycm9yKTtcclxuICAgIHRocm93IGVycm9yO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGRhdGEgfHwgW107XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBHZXQgVVRNIHBhcmFtZXRlciBicmVha2Rvd24gZnJvbSBHSEwgY29udGFjdHNcclxuICogQHBhcmFtIGRheXNCYWNrIC0gTnVtYmVyIG9mIGRheXMgdG8gbG9vayBiYWNrXHJcbiAqIEByZXR1cm5zIFVUTSBwYXJhbWV0ZXIgYW5hbHlzaXNcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRVdG1BbmFseXNpcyhkYXlzQmFjazogbnVtYmVyID0gMzApOiBQcm9taXNlPHtcclxuICBzb3VyY2VzOiB7IHZhbHVlOiBzdHJpbmc7IGNvdW50OiBudW1iZXIgfVtdO1xyXG4gIG1lZGl1bXM6IHsgdmFsdWU6IHN0cmluZzsgY291bnQ6IG51bWJlciB9W107XHJcbiAgY2FtcGFpZ25zOiB7IHZhbHVlOiBzdHJpbmc7IGNvdW50OiBudW1iZXIgfVtdO1xyXG4gIGxlYWRTb3VyY2VzOiB7IHZhbHVlOiBzdHJpbmc7IGNvdW50OiBudW1iZXIgfVtdO1xyXG59PiB7XHJcbiAgY29uc3Qgc3RhcnREYXRlID0gbmV3IERhdGUoKTtcclxuICBzdGFydERhdGUuc2V0RGF0ZShzdGFydERhdGUuZ2V0RGF0ZSgpIC0gZGF5c0JhY2spO1xyXG5cclxuICAvLyBGZXRjaCBHSEwgY29udGFjdHMgd2l0aCBhdHRyaWJ1dGlvbiBkYXRhXHJcbiAgY29uc3QgeyBkYXRhOiBjb250YWN0cywgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAuZnJvbSgnZ2hsX2NvbnRhY3RzJylcclxuICAgIC5zZWxlY3QoJ3NvdXJjZSwgZmlyc3RfYXR0cmlidXRpb25fc291cmNlLCBmaXJzdF9hdHRyaWJ1dGlvbl9tZWRpdW0sIGZpcnN0X2F0dHJpYnV0aW9uX3VybCcpXHJcbiAgICAuZ3RlKCdnaGxfZGF0ZV9hZGRlZCcsIHN0YXJ0RGF0ZS50b0lTT1N0cmluZygpKTtcclxuXHJcbiAgaWYgKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBmZXRjaGluZyBVVE0gYW5hbHlzaXM6JywgZXJyb3IpO1xyXG4gICAgdGhyb3cgZXJyb3I7XHJcbiAgfVxyXG5cclxuICAvLyBBZ2dyZWdhdGUgZGF0YVxyXG4gIGNvbnN0IHNvdXJjZU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XHJcbiAgY29uc3QgbWVkaXVtTWFwID0gbmV3IE1hcDxzdHJpbmcsIG51bWJlcj4oKTtcclxuICBjb25zdCBjYW1wYWlnbk1hcCA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XHJcbiAgY29uc3QgbGVhZFNvdXJjZU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XHJcblxyXG4gIGNvbnRhY3RzPy5mb3JFYWNoKChjb250YWN0KSA9PiB7XHJcbiAgICAvLyBDb3VudCBhdHRyaWJ1dGlvbiBzb3VyY2VzIC0gdXNlIGZpcnN0X2F0dHJpYnV0aW9uX3NvdXJjZVxyXG4gICAgaWYgKGNvbnRhY3QuZmlyc3RfYXR0cmlidXRpb25fc291cmNlKSB7XHJcbiAgICAgIHNvdXJjZU1hcC5zZXQoY29udGFjdC5maXJzdF9hdHRyaWJ1dGlvbl9zb3VyY2UsIChzb3VyY2VNYXAuZ2V0KGNvbnRhY3QuZmlyc3RfYXR0cmlidXRpb25fc291cmNlKSB8fCAwKSArIDEpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIENvdW50IG1lZGl1bXNcclxuICAgIGlmIChjb250YWN0LmZpcnN0X2F0dHJpYnV0aW9uX21lZGl1bSkge1xyXG4gICAgICBtZWRpdW1NYXAuc2V0KGNvbnRhY3QuZmlyc3RfYXR0cmlidXRpb25fbWVkaXVtLCAobWVkaXVtTWFwLmdldChjb250YWN0LmZpcnN0X2F0dHJpYnV0aW9uX21lZGl1bSkgfHwgMCkgKyAxKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBDb3VudCBsZWFkIHNvdXJjZXMgKGZvcm0vc3VydmV5IG5hbWVzKVxyXG4gICAgaWYgKGNvbnRhY3Quc291cmNlKSB7XHJcbiAgICAgIGxlYWRTb3VyY2VNYXAuc2V0KGNvbnRhY3Quc291cmNlLCAobGVhZFNvdXJjZU1hcC5nZXQoY29udGFjdC5zb3VyY2UpIHx8IDApICsgMSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUGFyc2UgVVRNIHBhcmFtcyBmcm9tIGZpcnN0X2F0dHJpYnV0aW9uX3VybCBmb3IgY2FtcGFpZ25zXHJcbiAgICBpZiAoY29udGFjdC5maXJzdF9hdHRyaWJ1dGlvbl91cmwpIHtcclxuICAgICAgY29uc3QgdXRtUGFyYW1zID0gcGFyc2VVdG1QYXJhbXMoY29udGFjdC5maXJzdF9hdHRyaWJ1dGlvbl91cmwpO1xyXG4gICAgICBpZiAodXRtUGFyYW1zLnV0bV9jYW1wYWlnbikge1xyXG4gICAgICAgIGNhbXBhaWduTWFwLnNldCh1dG1QYXJhbXMudXRtX2NhbXBhaWduLCAoY2FtcGFpZ25NYXAuZ2V0KHV0bVBhcmFtcy51dG1fY2FtcGFpZ24pIHx8IDApICsgMSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgLy8gQ29udmVydCB0byBhcnJheXMgYW5kIHNvcnQgYnkgY291bnRcclxuICBjb25zdCBzb3VyY2VzID0gQXJyYXkuZnJvbShzb3VyY2VNYXAuZW50cmllcygpKVxyXG4gICAgLm1hcCgoW3ZhbHVlLCBjb3VudF0pID0+ICh7IHZhbHVlLCBjb3VudCB9KSlcclxuICAgIC5zb3J0KChhLCBiKSA9PiBiLmNvdW50IC0gYS5jb3VudCk7XHJcblxyXG4gIGNvbnN0IG1lZGl1bXMgPSBBcnJheS5mcm9tKG1lZGl1bU1hcC5lbnRyaWVzKCkpXHJcbiAgICAubWFwKChbdmFsdWUsIGNvdW50XSkgPT4gKHsgdmFsdWUsIGNvdW50IH0pKVxyXG4gICAgLnNvcnQoKGEsIGIpID0+IGIuY291bnQgLSBhLmNvdW50KTtcclxuXHJcbiAgY29uc3QgY2FtcGFpZ25zID0gQXJyYXkuZnJvbShjYW1wYWlnbk1hcC5lbnRyaWVzKCkpXHJcbiAgICAubWFwKChbdmFsdWUsIGNvdW50XSkgPT4gKHsgdmFsdWUsIGNvdW50IH0pKVxyXG4gICAgLnNvcnQoKGEsIGIpID0+IGIuY291bnQgLSBhLmNvdW50KTtcclxuXHJcbiAgY29uc3QgbGVhZFNvdXJjZXMgPSBBcnJheS5mcm9tKGxlYWRTb3VyY2VNYXAuZW50cmllcygpKVxyXG4gICAgLm1hcCgoW3ZhbHVlLCBjb3VudF0pID0+ICh7IHZhbHVlLCBjb3VudCB9KSlcclxuICAgIC5zb3J0KChhLCBiKSA9PiBiLmNvdW50IC0gYS5jb3VudCk7XHJcblxyXG4gIHJldHVybiB7IHNvdXJjZXMsIG1lZGl1bXMsIGNhbXBhaWducywgbGVhZFNvdXJjZXMgfTtcclxufVxyXG4iXSwibWFwcGluZ3MiOiJBQUtBLFNBQVMsZ0JBQWdCO0FBc0VsQixnQkFBUyxlQUFlLEtBQXdCO0FBQ3JELFFBQU0sU0FBb0IsQ0FBQztBQUUzQixNQUFJO0FBRUYsUUFBSTtBQUVKLFFBQUksSUFBSSxXQUFXLFNBQVMsS0FBSyxJQUFJLFdBQVcsVUFBVSxHQUFHO0FBQzNELFlBQU0sU0FBUyxJQUFJLElBQUksR0FBRztBQUMxQixxQkFBZSxPQUFPO0FBQUEsSUFDeEIsV0FBVyxJQUFJLFdBQVcsR0FBRyxHQUFHO0FBQzlCLHFCQUFlLElBQUksZ0JBQWdCLEdBQUc7QUFBQSxJQUN4QyxPQUFPO0FBQ0wscUJBQWUsSUFBSSxnQkFBZ0IsTUFBTSxHQUFHO0FBQUEsSUFDOUM7QUFHQSxVQUFNLGFBQWEsYUFBYSxJQUFJLFlBQVk7QUFDaEQsVUFBTSxhQUFhLGFBQWEsSUFBSSxZQUFZO0FBQ2hELFVBQU0sZUFBZSxhQUFhLElBQUksY0FBYztBQUNwRCxV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